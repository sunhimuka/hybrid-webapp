name: Auto Commit and Deploy

on:
  workflow_dispatch:

permissions:
  contents: write   # ← これが重要。botにpush権限を付与

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Generate Contact Page
        run: |
          mkdir -p pages
          echo "<h1>Contact Page</h1><p>This is auto-generated!</p>" > pages/contact.js

      - name: Ensure .gitignore excludes node_modules
        run: |
          echo "node_modules/" >> .gitignore
          git rm -r --cached node_modules || true

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-generate contact page" || echo "No changes to commit"

      - name: Push changes
        run: git push origin main

  deploy:
    needs: generate-and-commit
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vercel Deployment
        run: |
          curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_${{ secrets.VERCEL_PROJECT_ID }} \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send notification email
        run: |
          echo "Subject: ✅ Commit & Deploy 完了" > mail.txt
          echo "GitHub Actionsからの通知です。" >> mail.txt
          echo "✔️ Commit & Deploy が成功しました！" >> mail.txt
          echo "" >> mail.txt
          echo "- Repository: $GITHUB_REPOSITORY" >> mail.txt
          echo "- Workflow: $GITHUB_WORKFLOW" >> mail.txt
          echo "- Run ID: $GITHUB_RUN_ID" >> mail.txt
          echo "- Status: success" >> mail.txt

          curl -s --url 'smtps://smtp.gmail.com:465' \
            --ssl-reqd \
            --mail-from "${{ secrets.GMAIL_USERNAME }}" \
            --mail-rcpt "sunhimuka1@gmail.com" \
            --user "${{ secrets.GMAIL_USERNAME }}:${{ secrets.GMAIL_APP_PASSWORD }}" \
            -T mail.txt
