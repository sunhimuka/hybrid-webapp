name: Auto Commit from Chat

on:
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Make changes
        run: |
          echo "Auto commit at $(date)" >> auto-commit-log.txt

      - name: Commit changes
        run: |
          git add auto-commit-log.txt
          git commit -m "Auto commit from GitHub Actions" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"

  deploy:
    runs-on: ubuntu-latest
    needs: commit
    steps:
      - name: Deploy to Vercel
        run: |
          curl -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "hybrid-webapp",
              "project": "'"${{ secrets.VERCEL_PROJECT_ID }}"'",
              "orgId": "'"${{ secrets.VERCEL_ORG_ID }}"'"
            }'

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send Gmail notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "✅ Hybrid WebApp - GitHub Actions通知"
          to: sunhimuka1@gmail.com
          from: GitHub Actions <${{ secrets.GMAIL_USERNAME }}>
          body: |
            GitHub Actionsからの通知です。

            ✅ Commit & Deploy 完了しました！

            - Repository: ${{ github.repository }}
            - Workflow: ${{ github.workflow }}
            - Run ID: ${{ github.run_id }}
            - Status: ${{ job.status }}
